## 임계구역

- n 개의 프로세스가 공유 데이터를 동시에 사용하기를 원하는 경우 그곳에 접근 하는 코드

### 프로그램적 해결법의 충족 조건

**Mutual Exclusion (상호 배제)**

- 프로세스가 임계구역 부분을 수행 중이면 다른 모든 프로세스들은 그들의 임계구역에 들어가면 안된다.

**Progress (진행)**

- 아무도 임계구역에 있지 않은 상태에서 임계구역에 들어가고자 하는 프로세스가 있다면, 임계구역에 들어가게 해줘야한다.

**Bounded Waiting (유한 대기)**

- 프로세스가 임계구역에 들어가려고 요청한 후 부터 그 요청이 허용될 때까지 다른 프로세스들이 임계구역에 들어가는 횟수에 한계가 있어야 한다.

⇒ 모든 프로세스의 수행 속도는 0보다 크며, 상대적 수행속도는 가정 X

### 문제 해결 알고리즘

**1.**

```c
do{
	while (turn != 0); /* 내 프로세스의 차례 */
	/* [임계구역] */
	turn = 1; /* 다른 프로세스의 차례 */
	/* [나머지 구역] */
} while(1);
```

turn이라는 변수를 가지고 자기 차례에만 임계구역에 들어가게된다.

⇒ **Mutual Exclusion(상호배제)를 만족한다.**

하지만, 프로세스 간의 임계구역에 들어가야하는 횟수가 다르다면 문제가 생기게 된다.

- 프로세스 1은 임계구역에 한 번만 들어가도 되고,
프로세스 2는 임계구역에 여러 번 들어가야 되는 상황이다.
- 코드가 한 번 작동한 이후, 프로세스 1이 더이상 들어갈 일이 없게 되기 때문에 프로세스 2에게는 자신의 차례가 돌아오지 않게 되버린다.

⇒ **Progress(진행) 문제를 만족하지 못한다.**

**2.**

```c
do{
	flag[i] = true;
	while(flag[j]);
	/* 임계구역 */
	flag [i] = false;
	/* 나머지구역 */
} whlile (1);
```

flag라는 변수를 가지고 임계구역에 들어갈 상태를 나타내게 된다.

- 다른 프로세스의 flag를 체크하고,
다른 프로세스의 flag가 true라면 양보, false라면 자기가 들어갈 수 있도록 한다.

**⇒ 이 또한 상호배제는 만족한다.**

얼핏 보기에는 문제가 없어 보이지만, 선점 때문에 문제가 발생 할 수있다.

- 프로세스 1이 임계구역에 들어가기 위해 flag를 true로 만들어 둔 상태에서 CPU를 뺏기게 된다.
- 프로세스 2도 임계구역에 들어가기 위해 flag를 true로 만들고 들어가려하는데,
다른 프로세스의 flag가 이미 true이기에, 양보를 하게된다.
- 프로세스 1에게 다시 CPU가 넘어와 임계구역에 들어가려하는데,
다른 프로세스의 flag가 true이므로 프로세스 1도 마찬가지로 양보를 하게되버린다.

**⇒ 무한정으로 양보하는 상황이 발생(아무도 임계구역에 들어갈 수 없음)**

**3.**

```c
do{
	flag[i] = true;
	turn = j;
	while(flag[i] && turn == j);
	/* 임계구역 */
	flag [i] = false;
	/* 나머지구역 */
} whlile (1);
```

flag 변수와 turn 변수를 둘 다 사용하는 방법이다.

- 자신과 상대의 차례와 상태를 모두 체크하여 만족하는 경우에만 임계구역에 들어가게 된다.

**⇒ 프로그램적 해결법의 충족 조건을 모두 만족하게 된다.**

*** 하지만 다른 문제점이 존재한다.

⇒ **Busy Waiting(=spin lock)** → 계속 CPU와 memory를 쓰면서 wait를 하고있는 상태 

### Synchronization Hardware

하드웨어적으로 Test & modify를 atomic 하게 수행할 수 있도록 지원하는 경우 앞의 문제는 간단히 해결 가능하다.

```c
Synchronization variable:
boolean lock = false;

do{
	while(Test_and_Set(lock));
	/* 임계구역 */
	lock = false;
	/* 나머지구역 */
} whlile (1);
```

**Test_and_set()** ⇒ 원래 값을 읽어내고, 그 값을 1로 세팅하는 작업을 하는 기능

- lock을 걸고 푸는 작업을 하나의 명령어로 처리하기 때문에,
문제를 손 쉽게 해결 할 수 있다.
